系统镜像升级
===========================

1. 选择镜像升级方式
---------------------------

系统软件更新方式有三种：

1. 在 **开发板端** 使用OTA命令行升级；
2. 在 **主机端** 使用hbupdate工具采用OTA方式升级；
3. 在 **主机端** 使用hbupdate工具采用uart方式升级。

.. tip::

  * 在系统能够正常启动的情况下，推荐使用在开发板端通过 OTA方式进行系统镜像更新。
  * 在开发板无法启动的情况下，则只能使用hbupdate工具的 uart 方式进行烧写。

2. 完成镜像升级前的准备工作
---------------------------

2.1 获取安装文件
^^^^^^^^^^^^^^^^^^^^^

系统软件安装文件可以从地平线OpenExplorer统一发布包(下称OE包)的 ``bsp`` 目录下获取，文件名为 ``J5-Img-{version}.zip``。 

OTA升级所需的 ``all_in_one_signed.zip`` 文件可以从解压后的 ``packages`` 文件夹中获取，uart升级所需的相关依赖均在 ``package`` 文件夹中。


2.2 获取正确的升级工具
^^^^^^^^^^^^^^^^^^^^^^^

开发板端OTA命令行升级所需的工具为 ``otaupdate``， 默认存放于板端 ``/usr/bin/otaupdate`` 路径中。

开发板升级工具hbupdate可以从OE包的 ``tools/hbupdate`` 目录下，根据用户使用的系统情况进行获取。 
除了适用于Windows64位系统的安装包，我们还提供了一个mac版本和两个linux版本的hbupdate工具，其中 ``gui`` 为图形用户接口， ``cli`` 为命令行用户接口。

.. attention::

  开发板升级工具hbupdate可能会随版本变动而有所变化，请以OE包中提供的最新工具为准。

2.3 安装串口驱动程序
^^^^^^^^^^^^^^^^^^^^^^^^

在连接开发板进行升级之前，请先在宿主机系统中安装串口驱动程序，否则宿主机系统可能无法辨认开发板。将串口驱动下载到您的宿主机中并完成安装。
串口驱动程序位于OE包的 ``tools/Windows_USB_Driver/CDM21228_Setup.zip``。

3. 执行镜像升级
---------------------------

3.1 开发板端OTA升级
^^^^^^^^^^^^^^^^^^^^^^^^^^^

用户在拿到一个新的OE包后，将OE包的 ``bsp`` 目录下的 ``J5-Img-{version}.zip`` 镜像文件解压，可从 ``package`` 文件夹中找到 ``all_in_one_signed.zip`` 镜像包。 
该镜像为签名认证过的镜像。
若使用未经签名的镜像则会导致更新失败。

将该系统软件包拷贝或挂载到 **开发板** 上，例如:

.. code-block:: bash

  scp all_in_one_signed.zip root@{ip}:/userdata/

登录开发板, 通过板上的otaupdate工具进行软件系统升级：

.. code-block:: bash

  /usr/bin/otaupdate all /userdata/all_in_one_signed.zip

OTA执行完镜像烧录后，会重启几次系统，验证升级是否成功。再次进入系统后，运行以下命令查看系统版本号来验证升级是否成功：

.. code-block:: bash

  cat /etc/issue

.. tip::

  由于该方式最简单且易上手，因此推荐用户在 **系统能够正常启动** 的前提下首先尝试使用此方法进行系统软件版本的升级。

3.2 hbupdate工具升级
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

3.2.1 使用前准备
***************************

使用hbupdate工具时，无论选择何种方式进行升级，都要确保主机端与板端分别通过串口和网线进行相连。

.. attention::

  * 串口端口号要选择正确（参考本节末尾的FAQ内容）；
  * 波特率设置与板上DIP开关设置一致；
  * 且板端ip与主机ip在同一个网段内。

升级前需要在工具中选择 ``产品类型``，因此需要 **与地平线技术支持人员确认目标开发板是否为加密板**。 
如果为非加密 ``nosecure`` 则 ``产品类型`` 选择 ``J5``； 如果为加密 ``secure`` 则 ``产品类型`` 选择 ``J5-key1``。
如下图所示：

.. figure:: ./j5_update_images/product_type.png

3.2.2 OTA方式升级
***************************

同命令行OTA升级，将OE包的 ``bsp`` 目录下的 ``J5-Img-{version}.zip`` 镜像文件解压，可从 ``package`` 文件夹中找到 ``all_in_one_signed.zip`` 镜像包。
该镜像为签名认证过的镜像。

.. attention::
  若使用未经签名的镜像则会导致更新失败。

在工具的 ``下载模式`` 中选择 ``ota``， ``下载方式`` 选择 ``sftp``， 并选择准备好的ota升级文件，之后填好板端的ip地址(``CP IP地址``)及PC串口信息。
如下图所示:

.. figure:: ./j5_update_images/ota_overview.png


设置完毕后，即可点击 ``开始升级``，
在升级成功后会出现相应提示。
如下图所示：

.. figure:: ./j5_update_images/hbupdate_ota_finish.png

3.2.3 uart方式升级
***************************

.. tip::

  在开发板镜像版本不支持ota方式升级、或系统已无法正常启动的情况下，则可选择uart方式进行烧写。

在工具的 ``下载模式`` 中选择 ``uart``， ``下载方式`` 选择 ``fastboot``， ``内存类型`` 选择 ``misc``， 
并在文件选择栏中选择之前从OE包中解压获取的 ``packages`` 文件夹，
并将板端的ip地址( ``CP IP地址``)、 ``网关地址`` (``MAC`` 选项可忽略不填)、 ``子网掩码``、 PC端 ``串口`` 和主机IP （ ``UDP IP``）设置好。
如下图所示：

.. figure:: ./j5_update_images/uart_overview.png


设置完毕后即可点击 ``开始升级``， 之后会出现相应提示。需要按照提示进行重启开发板的操作。
在升级成功后。同样会出现相应提示，如下图所示：

.. figure:: ./j5_update_images/hbupdate_uart_reset.png

.. figure:: ./j5_update_images/hbupdate_uart_finish.png

4. FAQ
---------------------------

4.1 升级工具与开发板网络连接失败怎么办？
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

如果在升级过程中遇到了开发板与主机之间网络连接失败的情况则可以进行以下检查：

* 检查电脑与开发板间网线是否已正确连接，且开发板与电脑直连；

* 检查电脑与开发板ip是否在同一网段，若不是的话请按下面步骤修改板子网段

  1. 登陆开发板，通过命令 ``hrut_ipfull s {开发板ip} {开发板子网掩码} {开发板网关}`` 将开发板IP设置为和主机一个网段。  
     示例： ``hrut_ipfull s 10.103.70.66 255.255.255.0 10.103.70.1``
     修改结果可以通过 ``hrut_ipfull g`` 来查看。

     .. code-block::

        root@j5dvb:~# hrut_ipfull g
        ip=10.103.70.68
        mask=255.255.255.0
        gw=10.103.70.1

  2. 创建 ``/userdata/app/init.sh`` 文件，将文件其中IP设置为和步骤1一致。
     设置完毕后执行 ``chmod 777 /userdata/app/init.sh``。文件内容如下图：

      .. code-block::

        #!/bin/sh
        ifconfig eth0 down
        ifconfig eth1 10.103.70.68 netmask 255.255.255.0
        route add default gw 10.103.70.1


  3. 设置完毕后重启开发板。开发板和主机双向ping，都能ping通则设置完毕。


4.2 使用hbupdate工具ota方式升级报错 ``can not connect chip via network``？
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

若升级过程中出现下列失败提示，则需登录开发板并执行 ``telnetd start`` ，退出后重新执行升级操作。

.. figure:: ./j5_update_images/faq2_network_error.png
  :align: center
  :scale: 80%

4.3 串口选择
^^^^^^^^^^^^^^^^^^^^^^

当串口线接入PC时，会在设备管理器中出现4个COM口。
这其中只有一个是能够正确与板端相连的。
用户需要依次进行升级尝试来判断具体哪个是正确的。
根据以往经验，工具 **下拉列表排列倒数第二** 串口为正确COM口，推荐从这个COM口开始试起。
